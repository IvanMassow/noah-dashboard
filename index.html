<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOAH â€” Signal Intelligence Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Lato:wght@300;400;700&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
<style>
:root {
    --paper: #FFF1E5;
    --paper-dark: #f5e6d3;
    --ink: #262a33;
    --ink-light: #3d424d;
    --grey-400: #9ca3af;
    --teal: #0d7680;
    --teal-light: #0f8f9a;
    --teal-bg: #e8f5f5;
    --gold: #d97706;
    --gold-bg: #fef3c7;
    --green: #16a34a;
    --green-bg: #dcfce7;
    --red: #cc0000;
    --red-bg: #fef2f2;
    --purple: #7c3aed;
    --dark-purple: #5b21b6;
    --border: #e0d5c7;
    --shadow: rgba(38, 42, 51, 0.08);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Lato', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    line-height: 1.5;
    padding-top: 56px;
}

/* --- HEADER (matches specialist pages) --- */
.header {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    background: var(--ink); height: 56px;
    display: flex; align-items: center; padding: 0 2rem;
}
.header .logo {
    font-family: 'Montserrat', sans-serif; font-weight: 700;
    color: #fff; font-size: 1.3rem; letter-spacing: 0.08em;
    text-transform: uppercase;
}
.header .nav { display: flex; gap: 1.5rem; margin-left: 3rem; }
.header .nav a {
    color: var(--grey-400); text-decoration: none;
    font-size: 0.82rem; letter-spacing: 0.04em;
    transition: color 0.2s;
}
.header .nav a:hover { color: #fff; }
.header .meta {
    margin-left: auto; color: var(--grey-400);
    font-size: 0.78rem; letter-spacing: 0.02em;
}

/* --- HERO --- */
.hero {
    background: var(--ink); color: #fff;
    padding: 40px 2rem 36px;
    text-align: center;
    position: relative;
    overflow: hidden;
}
.hero::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(
        90deg, transparent, transparent 50px,
        rgba(255,255,255,0.015) 50px, rgba(255,255,255,0.015) 51px
    );
}
.hero-content { position: relative; z-index: 1; }
.hero h1 {
    font-family: 'Montserrat', sans-serif;
    font-size: 2rem;
    font-weight: 700;
    color: #fff;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 6px;
}
.hero-sub {
    font-weight: 700;
    font-size: 0.72rem;
    color: #FFA089;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    margin-bottom: 24px;
}
.hero-stats {
    display: flex;
    justify-content: center;
    gap: 48px;
    flex-wrap: wrap;
}
.hero-stat { text-align: center; }
.hero-stat-value {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.6rem;
    font-weight: 700;
    color: #fff;
}
.hero-stat-value.green { color: var(--green); }
.hero-stat-value.red { color: #ff8c69; }
.hero-stat-value.teal { color: var(--teal-light); }
.hero-stat-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: rgba(255,241,229,0.4);
    margin-top: 2px;
}

/* --- CONTAINER --- */
.container { max-width: 1120px; margin: 0 auto; padding: 0 2rem; }
.main { padding: 32px 0 60px; }

/* --- SECTION --- */
.section { margin-bottom: 40px; }
.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--teal);
}
.section-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--ink);
}
.system-tag {
    display: inline-block;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.58rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    padding: 3px 10px;
    border-radius: 3px;
    margin-left: 10px;
    vertical-align: middle;
}
.tag-poly { background: var(--teal-bg); color: var(--teal); }
.tag-hedge { background: var(--gold-bg); color: var(--gold); }
.tag-cw { background: #fce7f3; color: #be185d; }

/* Company Watch specific */
.cw-dual-conf {
    display: flex;
    gap: 16px;
    align-items: center;
    margin-top: 8px;
}
.cw-conf-box {
    text-align: center;
    padding: 6px 14px;
    border-radius: 6px;
    background: var(--paper-dark);
}
.cw-conf-value {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
}
.cw-conf-label {
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--ink-light);
}
.badge-buy { background: var(--green-bg); color: var(--green); }
.badge-sell { background: var(--red-bg); color: var(--red); }
.badge-hold { background: var(--gold-bg); color: var(--gold); }
.badge-fade { background: #f1f5f9; color: #9ea2b0; }
.badge-flat { background: #f1f5f9; color: #9ea2b0; }
.badge-duck { background: var(--gold-bg); color: var(--gold); }

/* Full report button */
.full-report-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 18px;
    background: var(--teal);
    color: #fff;
    text-decoration: none;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    border-radius: 5px;
    transition: background 0.2s, transform 0.1s;
}
.full-report-btn:hover { background: var(--teal-light); transform: translateY(-1px); }
.full-report-btn svg { width: 14px; height: 14px; fill: currentColor; }

/* --- SUMMARY STRIP --- */
.summary-strip {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    margin-bottom: 18px;
}
.summary-card {
    flex: 1;
    min-width: 110px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    text-align: center;
}
.summary-card-value {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.35rem;
    font-weight: 700;
    color: var(--ink);
}
.summary-card-value.green { color: var(--green); }
.summary-card-value.red { color: var(--red); }
.summary-card-value.teal { color: var(--teal); }
.summary-card-value.gold { color: var(--gold); }
.summary-card-label {
    font-size: 0.66rem;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--ink-light);
    margin-top: 3px;
}

/* --- TRADE TABLE --- */
.trade-table-wrap {
    overflow-x: auto;
    background: white;
    border: 1px solid var(--border);
    border-radius: 10px;
    box-shadow: 0 2px 8px var(--shadow);
}
.trade-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.84rem;
}
.trade-table thead th {
    background: var(--paper-dark);
    font-family: 'Montserrat', sans-serif;
    font-size: 0.66rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--ink-light);
    padding: 11px 12px;
    text-align: left;
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
}
.trade-table tbody td {
    padding: 10px 12px;
    border-bottom: 1px solid #f0ebe4;
    vertical-align: middle;
}
.trade-table tbody tr:last-child td { border-bottom: none; }
.trade-table tbody tr:hover { background: rgba(13, 118, 128, 0.03); }
.trade-table tbody tr.killed-row { opacity: 0.6; }
.trade-table tbody tr.killed-row td { color: var(--ink-light); }

/* Cell styles */
.asset-cell {
    font-weight: 600;
    color: var(--ink);
    max-width: 260px;
}
.asset-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    max-width: 260px;
}
.asset-sub {
    font-size: 0.72rem;
    font-weight: 400;
    color: var(--ink-light);
    font-style: italic;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    max-width: 260px;
    margin-top: 1px;
}
.ticker-cell {
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    font-size: 0.82rem;
    color: var(--teal);
}
.badge {
    display: inline-block;
    padding: 2px 7px;
    border-radius: 4px;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 0.5px;
}
.badge-long { background: var(--green-bg); color: var(--green); }
.badge-short { background: var(--red-bg); color: var(--red); }
.badge-higher { background: var(--green-bg); color: var(--green); }
.badge-lower { background: var(--red-bg); color: var(--red); }
.badge-active { background: var(--green-bg); color: var(--green); }
.badge-publish { background: var(--gold-bg); color: var(--gold); }
.badge-watch { background: #f3e8ff; color: var(--purple); }
.badge-pending { background: #f1f5f9; color: #9ea2b0; }
.badge-killed { background: #ede9fe; color: var(--dark-purple); }
.badge-expired { background: #f1f5f9; color: #9ea2b0; }

.band-chip {
    display: inline-block;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.66rem;
    font-weight: 700;
    width: 22px; height: 22px; line-height: 22px;
    text-align: center;
    border-radius: 4px;
    color: white;
}

.pnl-positive { color: var(--green); font-weight: 700; }
.pnl-negative { color: var(--red); font-weight: 700; }
.pnl-flat { color: var(--ink-light); }

.status-dot {
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    margin-right: 4px;
    vertical-align: middle;
}
.dot-green { background: var(--green); }
.dot-red { background: var(--red); }
.dot-orange { background: #f59e0b; }
.dot-grey { background: #9ea2b0; }
.dot-purple { background: var(--dark-purple); }

/* --- LOADING --- */
.loading-spinner {
    display: inline-block;
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--teal);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-right: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-state {
    text-align: center;
    padding: 30px;
    color: var(--ink-light);
    font-size: 0.85rem;
}

/* --- LAST UPDATED --- */
.last-updated {
    text-align: center;
    font-size: 0.72rem;
    color: var(--ink-light);
    opacity: 0.6;
    margin-top: 10px;
}

/* --- FOOTER --- */
.footer {
    background: var(--ink);
    padding: 28px 24px;
    text-align: center;
}
.footer .logo {
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    color: #fff;
    font-size: 1rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 6px;
}
.footer-text {
    font-size: 0.72rem;
    color: rgba(255,241,229,0.35);
    letter-spacing: 0.5px;
}
.footer-text a { color: rgba(255,241,229,0.5); text-decoration: none; }
.footer-text a:hover { text-decoration: underline; }

/* --- RESPONSIVE --- */
@media (max-width: 700px) {
    .header { padding: 0 1rem; }
    .header .nav { margin-left: 1.5rem; gap: 1rem; }
    .hero { padding: 30px 1rem 28px; }
    .hero h1 { font-size: 1.5rem; }
    .hero-stats { gap: 24px; }
    .hero-stat-value { font-size: 1.2rem; }
    .container { padding: 0 1rem; }
    .summary-strip { gap: 8px; }
    .summary-card { min-width: 85px; padding: 10px 8px; }
    .summary-card-value { font-size: 1rem; }
    .section-title { font-size: 1.05rem; }
    .full-report-btn { padding: 6px 12px; font-size: 0.68rem; }
    .trade-table { font-size: 0.76rem; }
    .trade-table thead th { padding: 9px 8px; }
    .trade-table tbody td { padding: 8px; }
}
</style>
</head>
<body>

<!-- HEADER (same as specialist pages) -->
<div class="header">
    <div class="logo">NOAH</div>
    <div class="nav">
        <a href="#polyhunter">Prediction Markets</a>
        <a href="#hedgefund">Equity Signals</a>
        <a href="#companywatch">Company Watch</a>
    </div>
    <div class="meta" id="header-meta">Signal Intelligence Dashboard</div>
</div>

<!-- HERO -->
<div class="hero">
    <div class="hero-content">
        <h1>Bionic Ear</h1>
        <p class="hero-sub">Signal Intelligence Dashboard</p>
        <div class="hero-stats" id="hero-stats">
            <div class="hero-stat">
                <div class="hero-stat-value teal" id="hero-total">--</div>
                <div class="hero-stat-label">Total Positions</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value green" id="hero-active">--</div>
                <div class="hero-stat-label">Active Trades</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value" id="hero-winrate">--</div>
                <div class="hero-stat-label">Win Rate</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value" id="hero-systems">3</div>
                <div class="hero-stat-label">Live Systems</div>
            </div>
        </div>
    </div>
</div>

<div class="container">
<main class="main">

    <!-- POLYHUNTER SECTION -->
    <section class="section" id="polyhunter">
        <div class="section-header">
            <div class="section-title">
                Prediction Markets
                <span class="system-tag tag-poly">PolyHunter</span>
            </div>
            <a class="full-report-btn" href="https://ivanmassow.github.io/polyhunter/" target="_blank">
                View Full Results
                <svg viewBox="0 0 20 20"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5zM5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/></svg>
            </a>
        </div>

        <div class="summary-strip" id="poly-summary">
            <div class="summary-card">
                <div class="summary-card-value teal" id="poly-total">--</div>
                <div class="summary-card-label">Tracked</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value green" id="poly-winners">--</div>
                <div class="summary-card-label">Winners</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value red" id="poly-losers">--</div>
                <div class="summary-card-label">Losers</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value" id="poly-winrate">--</div>
                <div class="summary-card-label">Win Rate</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value" id="poly-best">--</div>
                <div class="summary-card-label">Best Trade</div>
            </div>
        </div>

        <div id="poly-trades">
            <div class="loading-state"><span class="loading-spinner"></span> Loading PolyHunter data&hellip;</div>
        </div>

        <div class="last-updated" id="poly-updated"></div>
    </section>

    <!-- HEDGE FUND SECTION -->
    <section class="section" id="hedgefund">
        <div class="section-header">
            <div class="section-title">
                Equity Signals
                <span class="system-tag tag-hedge">Hedge Fund</span>
            </div>
            <a class="full-report-btn" href="https://ivanmassow.github.io/hedgefund-tracker/" target="_blank" style="background:var(--gold)">
                View Full Results
                <svg viewBox="0 0 20 20"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5zM5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/></svg>
            </a>
        </div>

        <div class="summary-strip" id="hedge-summary">
            <div class="summary-card">
                <div class="summary-card-value teal" id="hedge-total">--</div>
                <div class="summary-card-label">Positions</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value green" id="hedge-active">--</div>
                <div class="summary-card-label">Active</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value gold" id="hedge-publish">--</div>
                <div class="summary-card-label">Publish</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value" id="hedge-pending">--</div>
                <div class="summary-card-label">Pending DD</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value" id="hedge-directions">--</div>
                <div class="summary-card-label">Long / Short</div>
            </div>
        </div>

        <div id="hedge-trades">
            <div class="loading-state"><span class="loading-spinner"></span> Loading Hedge Fund data&hellip;</div>
        </div>

        <div class="last-updated" id="hedge-updated"></div>
    </section>

    <!-- COMPANY WATCH SECTION -->
    <section class="section" id="companywatch">
        <div class="section-header">
            <div class="section-title">
                Company Watch
                <span class="system-tag tag-cw">Single Stock</span>
            </div>
            <a class="full-report-btn" href="https://ivanmassow.github.io/company-watch/" target="_blank" style="background:#be185d">
                View Full Report
                <svg viewBox="0 0 20 20"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5zM5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/></svg>
            </a>
        </div>

        <div class="summary-strip" id="cw-summary">
            <div class="summary-card">
                <div class="summary-card-value teal" id="cw-ticker">--</div>
                <div class="summary-card-label">Ticker</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value" id="cw-price">--</div>
                <div class="summary-card-label">Price</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value" id="cw-stance">--</div>
                <div class="summary-card-label">Stance</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value" id="cw-report-conf">--</div>
                <div class="summary-card-label">Report Conf</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value" id="cw-house-conf">--</div>
                <div class="summary-card-label">House Conf</div>
            </div>
        </div>

        <!-- Active vs Passive comparison -->
        <div id="cw-comparison" style="display:none">
            <div style="display:flex;gap:14px;flex-wrap:wrap;margin-bottom:18px">
                <div class="summary-card" style="flex:1;border-top:3px solid var(--teal)">
                    <div class="summary-card-value" id="cw-active-pnl">--</div>
                    <div class="summary-card-label">Active (AI)</div>
                </div>
                <div class="summary-card" style="flex:1;border-top:3px solid var(--gold)">
                    <div class="summary-card-value" id="cw-passive-pnl">--</div>
                    <div class="summary-card-label">Passive (Hold)</div>
                </div>
                <div class="summary-card" style="flex:1;border-top:3px solid var(--ink)">
                    <div class="summary-card-value" id="cw-alpha">--</div>
                    <div class="summary-card-label">Alpha</div>
                </div>
                <div class="summary-card" style="flex:1">
                    <div class="summary-card-value" id="cw-trades">--</div>
                    <div class="summary-card-label">Trades</div>
                </div>
                <div class="summary-card" style="flex:1">
                    <div class="summary-card-value" id="cw-winrate">--</div>
                    <div class="summary-card-label">Win Rate</div>
                </div>
            </div>
        </div>

        <div id="cw-details">
            <div class="loading-state"><span class="loading-spinner"></span> Loading Company Watch data&hellip;</div>
        </div>

        <div class="last-updated" id="cw-updated"></div>
    </section>

</main>
</div>

<!-- FOOTER -->
<footer class="footer">
    <a href="https://ivanmassow.github.io/noah-dashboard/" style="text-decoration:none"><div class="logo">NOAH</div></a>
    <div class="footer-text">
        Narrative Signal Analysis &middot; Information Asymmetry Intelligence
        <br>
        <a href="https://ivanmassow.github.io/polyhunter/">PolyHunter</a> &middot;
        <a href="https://ivanmassow.github.io/hedgefund-tracker/">Hedge Fund Tracker</a> &middot;
        <a href="https://ivanmassow.github.io/company-watch/">Company Watch</a>
    </div>
</footer>

<script>
// ========= DATA SOURCES =========
var POLY_URL = "https://ivanmassow.github.io/polyhunter/summary.json";
var HEDGE_URL = "https://ivanmassow.github.io/hedgefund-tracker/summary.json";
var CW_URL = "https://ivanmassow.github.io/company-watch/summary.json";

// ========= UTILITIES =========
function formatPnl(v) {
    if (v === null || v === undefined || v === 0) return '<span class="pnl-flat">0.0%</span>';
    var cls = v > 0 ? 'pnl-positive' : 'pnl-negative';
    var sign = v > 0 ? '+' : '';
    return '<span class="' + cls + '">' + sign + v.toFixed(1) + '%</span>';
}

function formatPrice(v) {
    if (!v && v !== 0) return '--';
    if (v < 1) return (v * 100).toFixed(1) + 'c';
    return '$' + v.toFixed(2);
}

function timeAgo(isoStr) {
    if (!isoStr) return '';
    var d = new Date(isoStr);
    var now = new Date();
    var mins = Math.floor((now - d) / 60000);
    if (mins < 1) return 'just now';
    if (mins < 60) return mins + 'min ago';
    var hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    var days = Math.floor(hrs / 24);
    return days + 'd ago';
}

function directionBadge(dir) {
    if (!dir) return '';
    var d = dir.toLowerCase();
    if (d === 'long' || d === 'higher') return '<span class="badge badge-' + d + '">' + dir.toUpperCase() + '</span>';
    if (d === 'short' || d === 'lower') return '<span class="badge badge-' + d + '">' + dir.toUpperCase() + '</span>';
    return '<span class="badge">' + dir + '</span>';
}

function stateBadge(state) {
    if (!state) return '';
    var s = state.toLowerCase();
    return '<span class="badge badge-' + s + '">' + state + '</span>';
}

function statusDot(status) {
    var s = (status || 'grey').toLowerCase();
    if (s === 'green' || s === 'active') return '<span class="status-dot dot-green"></span>';
    if (s === 'red') return '<span class="status-dot dot-red"></span>';
    if (s === 'orange') return '<span class="status-dot dot-orange"></span>';
    if (s === 'killed') return '<span class="status-dot dot-purple"></span>';
    return '<span class="status-dot dot-grey"></span>';
}

function bandChip(band) {
    if (!band) return '';
    var colors = {"A":"#0d7680","B":"#16a34a","C":"#f59e0b","D":"#ea580c","E":"#cc0000"};
    var bg = colors[band] || '#9ea2b0';
    return '<span class="band-chip" style="background:' + bg + '">' + band + '</span>';
}

function escHtml(s) {
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ========= POLY HUNTER =========
function renderPoly(data) {
    document.getElementById('poly-total').textContent = data.total_candidates || 0;
    document.getElementById('poly-winners').textContent = data.winners || 0;
    document.getElementById('poly-losers').textContent = data.losers || 0;
    document.getElementById('poly-winrate').textContent = (data.win_rate || 0).toFixed(1) + '%';
    document.getElementById('poly-best').innerHTML = formatPnl(data.best_trade || 0);
    document.getElementById('poly-updated').textContent = 'Updated ' + timeAgo(data.updated_at);

    var positions = data.recent_positions || data.active_trades || [];
    var container = document.getElementById('poly-trades');

    if (positions.length === 0) {
        container.innerHTML = '<div class="loading-state" style="opacity:0.6">No data available yet</div>';
        return;
    }

    var html = '<div class="trade-table-wrap"><table class="trade-table"><thead><tr>';
    html += '<th>State</th><th>Event</th><th>Edge</th><th>Direction</th>';
    html += '<th>Rating</th><th>Entry</th><th>Current</th><th>P&amp;L</th>';
    html += '</tr></thead><tbody>';

    for (var i = 0; i < positions.length; i++) {
        var t = positions[i];
        var isKilled = (t.state === 'KILLED');
        var rowCls = isKilled ? ' class="killed-row"' : '';

        html += '<tr' + rowCls + '>';
        html += '<td>' + stateBadge(t.state || 'EXPIRED') + '</td>';
        html += '<td class="asset-cell"><span class="asset-name">' + escHtml(t.event) + '</span>';
        if (isKilled && t.kill_reason) {
            html += '<span class="asset-sub">' + escHtml(t.kill_reason) + '</span>';
        }
        html += '</td>';
        html += '<td><span class="badge">' + escHtml(t.edge_type || '?') + '</span></td>';
        html += '<td>' + directionBadge(t.direction) + '</td>';
        html += '<td>' + bandChip(t.rating) + '</td>';
        html += '<td style="font-family:Montserrat,sans-serif;font-size:0.8rem">' + formatPrice(t.entry_price) + '</td>';
        html += '<td style="font-family:Montserrat,sans-serif;font-size:0.8rem">' + formatPrice(t.current_price) + '</td>';
        html += '<td>' + formatPnl(t.pnl_pct) + '</td>';
        html += '</tr>';
    }

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// ========= HEDGE FUND =========
function renderHedge(data) {
    document.getElementById('hedge-total').textContent = data.total_positions || 0;
    document.getElementById('hedge-active').textContent = data.active_count || 0;
    document.getElementById('hedge-publish').textContent = data.publish_count || 0;
    document.getElementById('hedge-pending').textContent = data.pending_count || 0;
    document.getElementById('hedge-directions').textContent =
        (data.long_count || 0) + 'L / ' + (data.short_count || 0) + 'S';
    document.getElementById('hedge-updated').textContent = 'Updated ' + timeAgo(data.updated_at);

    var positions = data.recent_positions || data.active_trades || [];
    var container = document.getElementById('hedge-trades');

    if (positions.length === 0) {
        container.innerHTML = '<div class="loading-state" style="opacity:0.6">No data available yet</div>';
        return;
    }

    var html = '<div class="trade-table-wrap"><table class="trade-table"><thead><tr>';
    html += '<th>State</th><th>Asset</th><th>Ticker</th><th>Dir</th>';
    html += '<th>Band</th><th>Conf</th><th>Entry</th><th>P&amp;L</th>';
    html += '</tr></thead><tbody>';

    for (var i = 0; i < positions.length; i++) {
        var t = positions[i];
        var isKilled = (t.state === 'KILLED');
        var rowCls = isKilled ? ' class="killed-row"' : '';

        html += '<tr' + rowCls + '>';
        html += '<td>' + stateBadge(t.state) + '</td>';
        html += '<td class="asset-cell"><span class="asset-name">' + escHtml(t.asset) + '</span>';
        // Show headline or kill reason as subtitle
        if (t.headline) {
            html += '<span class="asset-sub">' + escHtml(t.headline) + '</span>';
        } else if (isKilled && t.kill_reason) {
            html += '<span class="asset-sub">' + escHtml(t.kill_reason) + '</span>';
        } else if (t.state_reason) {
            html += '<span class="asset-sub">' + escHtml(t.state_reason) + '</span>';
        }
        html += '</td>';
        html += '<td class="ticker-cell">' + escHtml(t.ticker || '--') + '</td>';
        html += '<td>' + directionBadge(t.direction) + '</td>';
        html += '<td>' + bandChip(t.band) + '</td>';
        html += '<td>';
        if (t.confidence) {
            html += '<span style="font-family:Montserrat,sans-serif;font-size:0.8rem">' + t.confidence + '%</span>';
        }
        html += '</td>';
        html += '<td style="font-family:Montserrat,sans-serif;font-size:0.8rem">' +
            (t.entry_price ? '$' + t.entry_price.toFixed(2) : '--') + '</td>';
        html += '<td>' + formatPnl(t.current_pnl) + '</td>';
        html += '</tr>';
    }

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// ========= COMPANY WATCH =========
function renderCW(data) {
    document.getElementById('cw-ticker').textContent = data.ticker || '--';
    document.getElementById('cw-price').textContent = data.current_price ? '$' + data.current_price.toFixed(2) : '--';

    var stance = (data.active && data.active.stance) || 'FLAT';
    var stanceEl = document.getElementById('cw-stance');
    stanceEl.innerHTML = '<span class="badge badge-' + stance.toLowerCase() + '">' + stance + '</span>';

    var rConf = (data.active && data.active.report_confidence) || 0;
    var hConf = (data.active && data.active.house_confidence) || 0;
    document.getElementById('cw-report-conf').textContent = rConf ? rConf.toFixed(0) + '%' : '--';
    document.getElementById('cw-house-conf').textContent = hConf ? hConf.toFixed(0) + '%' : '--';

    // Color the house confidence based on divergence from report
    var hEl = document.getElementById('cw-house-conf');
    if (hConf > rConf + 5) hEl.className = 'summary-card-value green';
    else if (hConf < rConf - 5) hEl.className = 'summary-card-value red';
    else hEl.className = 'summary-card-value teal';

    // Active vs Passive comparison
    var compDiv = document.getElementById('cw-comparison');
    compDiv.style.display = '';

    var aPnl = (data.active && data.active.unrealised_pnl) || 0;
    var pPnl = (data.passive && data.passive.pnl) || 0;
    var alpha = data.alpha || 0;

    document.getElementById('cw-active-pnl').innerHTML = formatPnl(aPnl);
    document.getElementById('cw-passive-pnl').innerHTML = formatPnl(pPnl);
    document.getElementById('cw-alpha').innerHTML = formatPnl(alpha);
    document.getElementById('cw-trades').textContent = data.total_trades || 0;
    document.getElementById('cw-winrate').textContent = (data.win_rate || 0).toFixed(1) + '%';

    document.getElementById('cw-updated').textContent = 'Updated ' + timeAgo(data.generated_at);

    // Show state and ducking status
    var details = document.getElementById('cw-details');
    var state = (data.active && data.active.state) || 'FLAT';
    var isDucking = data.active && data.active.is_ducking;
    var daysTracked = data.days_tracked || 0;

    var html = '<div class="trade-table-wrap"><table class="trade-table"><thead><tr>';
    html += '<th>Ticker</th><th>State</th><th>Direction</th><th>Entry</th><th>Active P&L</th><th>Passive P&L</th><th>Alpha</th><th>Days</th>';
    html += '</tr></thead><tbody>';
    html += '<tr>';
    html += '<td class="ticker-cell">' + escHtml(data.ticker) + '</td>';
    html += '<td>' + stateBadge(state) + (isDucking ? ' <span class="badge badge-duck">DUCK</span>' : '') + '</td>';
    html += '<td>' + directionBadge(data.active && data.active.direction || '') + '</td>';
    html += '<td style="font-family:Montserrat,sans-serif;font-size:0.8rem">' +
        (data.active && data.active.entry_price ? '$' + data.active.entry_price.toFixed(2) : '--') + '</td>';
    html += '<td>' + formatPnl(aPnl) + '</td>';
    html += '<td>' + formatPnl(pPnl) + '</td>';
    html += '<td>' + formatPnl(alpha) + '</td>';
    html += '<td>' + daysTracked + '</td>';
    html += '</tr>';
    html += '</tbody></table></div>';
    details.innerHTML = html;
}

// ========= HERO AGGREGATION =========
function updateHero(polyData, hedgeData, cwData) {
    var totalPoly = (polyData && polyData.total_candidates) || 0;
    var totalHedge = (hedgeData && hedgeData.total_positions) || 0;
    var totalCW = cwData ? 1 : 0;
    document.getElementById('hero-total').textContent = totalPoly + totalHedge + totalCW;

    var activeHedge = (hedgeData && hedgeData.active_count) || 0;
    var activePoly = 0;
    if (polyData && polyData.recent_positions) {
        for (var i = 0; i < polyData.recent_positions.length; i++) {
            if (polyData.recent_positions[i].state === 'ACTIVE') activePoly++;
        }
    }
    var activeCW = (cwData && cwData.active && cwData.active.state === 'HELD') ? 1 : 0;
    document.getElementById('hero-active').textContent = activePoly + activeHedge + activeCW;

    var wr = (polyData && polyData.win_rate) || 0;
    var wrEl = document.getElementById('hero-winrate');
    wrEl.textContent = wr.toFixed(1) + '%';
    wrEl.className = 'hero-stat-value ' + (wr >= 50 ? 'green' : wr > 0 ? '' : '');
}

// ========= FETCH & RENDER =========
var polyData = null;
var hedgeData = null;
var cwData = null;

function fetchAndRender() {
    fetch(POLY_URL, { cache: 'no-cache' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            polyData = data;
            renderPoly(data);
            updateHero(polyData, hedgeData, cwData);
        })
        .catch(function(err) {
            console.warn('PolyHunter fetch error:', err);
            document.getElementById('poly-trades').innerHTML =
                '<div class="loading-state" style="opacity:0.5">Unable to load PolyHunter data</div>';
        });

    fetch(HEDGE_URL, { cache: 'no-cache' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            hedgeData = data;
            renderHedge(data);
            updateHero(polyData, hedgeData, cwData);
        })
        .catch(function(err) {
            console.warn('Hedge Fund fetch error:', err);
            document.getElementById('hedge-trades').innerHTML =
                '<div class="loading-state" style="opacity:0.5">Unable to load Hedge Fund data</div>';
        });

    fetch(CW_URL, { cache: 'no-cache' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            cwData = data;
            renderCW(data);
            updateHero(polyData, hedgeData, cwData);
        })
        .catch(function(err) {
            console.warn('Company Watch fetch error:', err);
            document.getElementById('cw-details').innerHTML =
                '<div class="loading-state" style="opacity:0.5">Unable to load Company Watch data</div>';
        });
}

// Initial load
fetchAndRender();

// Auto-refresh every 5 minutes
setInterval(fetchAndRender, 5 * 60 * 1000);
</script>

</body>
</html>