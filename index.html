<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOAH — Signal Intelligence Dashboard</title>
<!-- Open Graph / Social sharing preview -->
<meta property="og:type" content="website">
<meta property="og:title" content="NOAH - Signal Intelligence Dashboard">
<meta property="og:description" content="Bionic Ear signal intelligence. Prediction markets, equity signals, and company watch — all in one dashboard.">
<meta property="og:image" content="https://ivanmassow.github.io/noah-dashboard/og-image.png?v=2">
<meta property="og:url" content="https://ivanmassow.github.io/noah-dashboard/">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="NOAH - Signal Intelligence Dashboard">
<meta name="twitter:description" content="Bionic Ear signal intelligence. Prediction markets, equity signals, and company watch — all in one dashboard.">
<meta name="twitter:image" content="https://ivanmassow.github.io/noah-dashboard/og-image.png?v=2">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Lato:wght@300;400;700&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
<style>
:root {
    --paper: #FFF1E5;
    --paper-dark: #f5e6d3;
    --ink: #262a33;
    --ink-light: #3d424d;
    --grey-400: #9ca3af;
    --teal: #0d7680;
    --teal-light: #0f8f9a;
    --teal-bg: #e8f5f5;
    --gold: #d97706;
    --gold-bg: #fef3c7;
    --green: #16a34a;
    --green-bg: #dcfce7;
    --red: #cc0000;
    --red-bg: #fef2f2;
    --purple: #7c3aed;
    --dark-purple: #5b21b6;
    --border: #e0d5c7;
    --shadow: rgba(38, 42, 51, 0.08);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Lato', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    line-height: 1.5;
    padding-top: 56px;
}

/* --- HEADER (matches specialist pages) --- */
.header {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    background: var(--ink); height: 56px;
    display: flex; align-items: center; padding: 0 2rem;
}
.header .logo {
    font-family: 'Montserrat', sans-serif; font-weight: 700;
    color: #fff; font-size: 1.3rem; letter-spacing: 0.08em;
    text-transform: uppercase;
}
.header .nav { display: flex; gap: 1.5rem; margin-left: 3rem; }
.header .nav a {
    color: var(--grey-400); text-decoration: none;
    font-size: 0.82rem; letter-spacing: 0.04em;
    transition: color 0.2s;
}
.header .nav a:hover { color: #fff; }
.header .meta {
    margin-left: auto; color: var(--grey-400);
    font-size: 0.78rem; letter-spacing: 0.02em;
}

/* --- HERO --- */
.hero {
    background: var(--ink); color: #fff;
    padding: 40px 2rem 36px;
    text-align: center;
    position: relative;
    overflow: hidden;
}
.hero::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(
        90deg, transparent, transparent 50px,
        rgba(255,255,255,0.015) 50px, rgba(255,255,255,0.015) 51px
    );
}
.hero-content { position: relative; z-index: 1; }
.hero h1 {
    font-family: 'Montserrat', sans-serif;
    font-size: 2rem;
    font-weight: 700;
    color: #fff;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 6px;
}
.hero-sub {
    font-weight: 700;
    font-size: 0.72rem;
    color: #FFA089;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    margin-bottom: 24px;
}
.hero-stats {
    display: flex;
    justify-content: center;
    gap: 48px;
    flex-wrap: wrap;
}
.hero-stat { text-align: center; }
.hero-stat-value {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.6rem;
    font-weight: 700;
    color: #fff;
}
.hero-stat-value.green { color: var(--green); }
.hero-stat-value.red { color: #ff8c69; }
.hero-stat-value.teal { color: var(--teal-light); }
.hero-stat-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: rgba(255,241,229,0.4);
    margin-top: 2px;
}

/* --- CONTAINER --- */
.container { max-width: 1120px; margin: 0 auto; padding: 0 2rem; }
.main { padding: 32px 0 60px; }

/* --- SECTION --- */
.section { margin-bottom: 40px; }
.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--teal);
}
.section-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--ink);
}
.system-tag {
    display: inline-block;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.58rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    padding: 3px 10px;
    border-radius: 3px;
    margin-left: 10px;
    vertical-align: middle;
}
.tag-poly { background: var(--teal-bg); color: var(--teal); }
.tag-hedge { background: var(--gold-bg); color: var(--gold); }
.tag-cw { background: #fce7f3; color: #be185d; }

/* Company Watch stock tiles */
.cw-stock-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 18px;
}
.cw-tile {
    background: white;
    border-radius: 10px;
    padding: 20px 22px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    border-top: 4px solid #be185d;
    transition: transform 0.15s;
    text-decoration: none;
    color: inherit;
    display: block;
}
.cw-tile:hover { transform: translateY(-2px); }
.cw-tile-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.cw-tile-ticker {
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    font-size: 1.3em;
    color: #be185d;
}
.cw-tile-company {
    font-size: 0.78em;
    color: var(--ink-light);
}
.cw-tile-price {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.7em;
    font-weight: 700;
    margin-bottom: 8px;
}
.cw-tile-stats {
    display: flex;
    gap: 16px;
    font-size: 0.82em;
}
.cw-tile-stats span { color: var(--ink-light); }
.badge-buy { background: var(--green-bg); color: var(--green); }
.badge-sell { background: var(--red-bg); color: var(--red); }
.badge-hold { background: var(--gold-bg); color: var(--gold); }
.badge-fade { background: #f1f5f9; color: #9ea2b0; }
.badge-flat { background: #f1f5f9; color: #9ea2b0; }
.badge-duck { background: var(--gold-bg); color: var(--gold); }

/* Full report button */
.full-report-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 18px;
    background: var(--teal);
    color: #fff;
    text-decoration: none;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    border-radius: 5px;
    transition: background 0.2s, transform 0.1s;
}
.full-report-btn:hover { background: var(--teal-light); transform: translateY(-1px); }
.full-report-btn svg { width: 14px; height: 14px; fill: currentColor; }

/* --- SUMMARY STRIP --- */
.summary-strip {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    margin-bottom: 18px;
}
.summary-card {
    flex: 1;
    min-width: 110px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    text-align: center;
}
.summary-card-value {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.35rem;
    font-weight: 700;
    color: var(--ink);
}
.summary-card-value.green { color: var(--green); }
.summary-card-value.red { color: var(--red); }
.summary-card-value.teal { color: var(--teal); }
.summary-card-value.gold { color: var(--gold); }
.summary-card-label {
    font-size: 0.66rem;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--ink-light);
    margin-top: 3px;
}

/* --- TRADE TABLE --- */
.trade-table-wrap {
    overflow-x: auto;
    background: white;
    border: 1px solid var(--border);
    border-radius: 10px;
    box-shadow: 0 2px 8px var(--shadow);
}
.trade-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.84rem;
}
.trade-table thead th {
    background: var(--paper-dark);
    font-family: 'Montserrat', sans-serif;
    font-size: 0.66rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--ink-light);
    padding: 11px 12px;
    text-align: left;
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
}
.trade-table tbody td {
    padding: 10px 12px;
    border-bottom: 1px solid #f0ebe4;
    vertical-align: middle;
}
.trade-table tbody tr:last-child td { border-bottom: none; }
.trade-table tbody tr:hover { background: rgba(13, 118, 128, 0.03); }
.trade-table tbody tr.killed-row { opacity: 0.6; }
.trade-table tbody tr.killed-row td { color: var(--ink-light); }

/* Cell styles */
.asset-cell {
    font-weight: 600;
    color: var(--ink);
    max-width: 260px;
}
.asset-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    max-width: 260px;
}
.asset-sub {
    font-size: 0.72rem;
    font-weight: 400;
    color: var(--ink-light);
    font-style: italic;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    max-width: 260px;
    margin-top: 1px;
}
.ticker-cell {
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    font-size: 0.82rem;
    color: var(--teal);
}
.badge {
    display: inline-block;
    padding: 2px 7px;
    border-radius: 4px;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 0.5px;
}
.badge-long { background: var(--green-bg); color: var(--green); }
.badge-short { background: var(--red-bg); color: var(--red); }
.badge-higher { background: var(--green-bg); color: var(--green); }
.badge-lower { background: var(--red-bg); color: var(--red); }
.badge-active { background: var(--green-bg); color: var(--green); }
.badge-publish { background: var(--gold-bg); color: var(--gold); }
.badge-watch { background: #f3e8ff; color: var(--purple); }
.badge-pending { background: #f1f5f9; color: #9ea2b0; }
.badge-killed { background: #ede9fe; color: var(--dark-purple); }
.badge-exited { background: #dbeafe; color: #1e40af; }
.badge-watching { background: #fef3c7; color: #92400e; }
.badge-expired { background: #f1f5f9; color: #9ea2b0; }

.band-chip {
    display: inline-block;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.66rem;
    font-weight: 700;
    width: 22px; height: 22px; line-height: 22px;
    text-align: center;
    border-radius: 4px;
    color: white;
}

.pnl-positive { color: var(--green); font-weight: 700; }
.pnl-negative { color: var(--red); font-weight: 700; }
.pnl-flat { color: var(--ink-light); }

.status-dot {
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    margin-right: 4px;
    vertical-align: middle;
}
.dot-green { background: var(--green); }
.dot-red { background: var(--red); }
.dot-orange { background: #f59e0b; }
.dot-grey { background: #9ea2b0; }
.dot-purple { background: var(--dark-purple); }

/* --- LOADING --- */
.loading-spinner {
    display: inline-block;
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--teal);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-right: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-state {
    text-align: center;
    padding: 30px;
    color: var(--ink-light);
    font-size: 0.85rem;
}

/* --- LAST UPDATED --- */
.last-updated {
    text-align: center;
    font-size: 0.72rem;
    color: var(--ink-light);
    opacity: 0.6;
    margin-top: 10px;
}

/* --- FOOTER --- */
.footer {
    background: var(--ink);
    padding: 28px 24px;
    text-align: center;
}
.footer .logo {
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    color: #fff;
    font-size: 1rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 6px;
}
.footer-text {
    font-size: 0.72rem;
    color: rgba(255,241,229,0.35);
    letter-spacing: 0.5px;
}
.footer-text a { color: rgba(255,241,229,0.5); text-decoration: none; }
.footer-text a:hover { text-decoration: underline; }

/* --- RESPONSIVE --- */
@media (max-width: 700px) {
    .header { padding: 0 1rem; }
    .header .nav { margin-left: 1.5rem; gap: 1rem; }
    .hero { padding: 30px 1rem 28px; }
    .hero h1 { font-size: 1.5rem; }
    .hero-stats { gap: 24px; }
    .hero-stat-value { font-size: 1.2rem; }
    .container { padding: 0 1rem; }
    .summary-strip { gap: 8px; }
    .summary-card { min-width: 85px; padding: 10px 8px; }
    .summary-card-value { font-size: 1rem; }
    .section-title { font-size: 1.05rem; }
    .full-report-btn { padding: 6px 12px; font-size: 0.68rem; }
    .trade-table { font-size: 0.76rem; }
    .trade-table thead th { padding: 9px 8px; }
    .trade-table tbody td { padding: 8px; }
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <a href="https://ivanmassow.github.io/noah-dashboard/" style="text-decoration:none"><div class="logo">NOAH</div></a>
    <div class="nav">
        <a href="https://ivanmassow.github.io/polyhunter/">Poly Market</a>
        <a href="https://ivanmassow.github.io/hedgefund-tracker/">Hedge Fund</a>
        <a href="https://ivanmassow.github.io/company-watch/">Company Watch</a>
    </div>
    <div class="meta" id="header-meta">Trading Intel</div>
</div>

<!-- HERO -->
<div class="hero">
    <div class="hero-content">
        <h1>Bionic Ear</h1>
        <p class="hero-sub">Trading Intel</p>
        <div class="hero-stats" id="hero-stats">
            <div class="hero-stat">
                <div class="hero-stat-value teal" id="hero-total">--</div>
                <div class="hero-stat-label">Total Positions</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value green" id="hero-active">--</div>
                <div class="hero-stat-label">Active Trades</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value" id="hero-wr-poly">--</div>
                <div class="hero-stat-label">Poly Market WR</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value" id="hero-wr-hedge">--</div>
                <div class="hero-stat-label">Hedge Fund WR</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value" id="hero-wr-cw">--</div>
                <div class="hero-stat-label">Company Watch WR</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value" id="hero-systems">3</div>
                <div class="hero-stat-label">Live Systems</div>
            </div>
        </div>
    </div>
</div>

<div class="container">
<main class="main">

    <!-- POLYHUNTER SECTION -->
    <section class="section" id="polyhunter">
        <div class="section-header">
            <div class="section-title">
                Poly Market
                <span class="system-tag tag-poly">Edge Tracker</span>
            </div>
            <a class="full-report-btn" href="https://ivanmassow.github.io/polyhunter/" target="_blank">
                View Full Results
                <svg viewBox="0 0 20 20"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5zM5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/></svg>
            </a>
        </div>

        <!-- SHORT TAIL -->
        <div style="margin-bottom:0.5rem">
            <h3 style="font-family:'Playfair Display',serif;font-size:1.05rem;color:var(--ink);margin:0 0 0.6rem">Short Tail <span style="font-size:0.72rem;font-weight:400;color:var(--ink-light)">&mdash; 16h window, ~400 articles</span></h3>
            <div class="summary-strip" id="poly-short-summary">
                <div class="summary-card">
                    <div class="summary-card-value teal" id="poly-short-total">--</div>
                    <div class="summary-card-label">Tracked</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-value green" id="poly-short-winners">--</div>
                    <div class="summary-card-label">Winners</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-value red" id="poly-short-losers">--</div>
                    <div class="summary-card-label">Losers</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-value" id="poly-short-winrate">--</div>
                    <div class="summary-card-label">Win Rate</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-value" id="poly-short-best">--</div>
                    <div class="summary-card-label">Best Trade</div>
                </div>
            </div>
            <div id="poly-short-trades">
                <div class="loading-state"><span class="loading-spinner"></span> Loading&hellip;</div>
            </div>
        </div>

        <!-- LONG TAIL -->
        <div style="margin-top:1.5rem">
            <h3 style="font-family:'Playfair Display',serif;font-size:1.05rem;color:var(--ink);margin:0 0 0.6rem">Long Tail <span style="font-size:0.72rem;font-weight:400;color:var(--ink-light)">&mdash; 8-day window, ~35 curated articles</span></h3>
            <div class="summary-strip" id="poly-long-summary">
                <div class="summary-card">
                    <div class="summary-card-value teal" id="poly-long-total">--</div>
                    <div class="summary-card-label">Tracked</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-value green" id="poly-long-winners">--</div>
                    <div class="summary-card-label">Winners</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-value red" id="poly-long-losers">--</div>
                    <div class="summary-card-label">Losers</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-value" id="poly-long-winrate">--</div>
                    <div class="summary-card-label">Win Rate</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-value" id="poly-long-best">--</div>
                    <div class="summary-card-label">Best Trade</div>
                </div>
            </div>
            <div id="poly-long-trades">
                <div class="loading-state"><span class="loading-spinner"></span> Loading&hellip;</div>
            </div>
        </div>

        <div class="last-updated" id="poly-updated"></div>
    </section>

    <!-- HEDGE FUND SECTION -->
    <section class="section" id="hedgefund">
        <div class="section-header">
            <div class="section-title">
                Hedge Fund
                <span class="system-tag tag-hedge">Edge Tracker</span>
            </div>
            <a class="full-report-btn" href="https://ivanmassow.github.io/hedgefund-tracker/" target="_blank" style="background:var(--gold)">
                View Full Results
                <svg viewBox="0 0 20 20"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5zM5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/></svg>
            </a>
        </div>

        <div class="summary-strip" id="hedge-summary">
            <div class="summary-card">
                <div class="summary-card-value teal" id="hedge-total">--</div>
                <div class="summary-card-label">Positions</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value green" id="hedge-active">--</div>
                <div class="summary-card-label">Active</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value gold" id="hedge-publish">--</div>
                <div class="summary-card-label">Publish</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value" id="hedge-pending">--</div>
                <div class="summary-card-label">Pending DD</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-value" id="hedge-directions">--</div>
                <div class="summary-card-label">Long / Short</div>
            </div>
        </div>

        <div id="hedge-trades">
            <div class="loading-state"><span class="loading-spinner"></span> Loading Hedge Fund data&hellip;</div>
        </div>

        <div class="last-updated" id="hedge-updated"></div>
    </section>

    <!-- COMPANY WATCH SECTION -->
    <section class="section" id="companywatch">
        <div class="section-header">
            <div class="section-title">
                Company Watch
                <span class="system-tag tag-cw">Stock Intelligence</span>
            </div>
            <a class="full-report-btn" href="https://ivanmassow.github.io/company-watch/" target="_blank" style="background:#be185d">
                View All Reports
                <svg viewBox="0 0 20 20"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5zM5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/></svg>
            </a>
        </div>

        <div class="cw-stock-grid" id="cw-tiles">
            <div class="loading-state"><span class="loading-spinner"></span> Loading Company Watch data&hellip;</div>
        </div>

        <div class="last-updated" id="cw-updated"></div>
    </section>

</main>
</div>

<!-- FOOTER -->
<footer class="footer">
    <a href="https://ivanmassow.github.io/noah-dashboard/" style="text-decoration:none"><div class="logo">NOAH</div></a>
    <div class="footer-text">
        Narrative Signal Analysis &middot; Information Asymmetry Intelligence
        <br>
        <a href="https://ivanmassow.github.io/polyhunter/">Poly Market</a> &middot;
        <a href="https://ivanmassow.github.io/hedgefund-tracker/">Hedge Fund</a> &middot;
        <a href="https://ivanmassow.github.io/company-watch/">Company Watch</a>
    </div>
    <div style="margin-top:1.8rem;max-width:640px;margin-left:auto;margin-right:auto;padding:0 1rem">
        <p style="font-size:0.72rem;color:rgba(255,241,229,0.55);line-height:1.7;text-align:center">
            <strong style="color:rgba(255,241,229,0.7);letter-spacing:0.08em;text-transform:uppercase;font-size:0.68rem">Disclaimer</strong><br>
            You are welcome to view these pages. The trading algorithms and analysis presented here are experimental and under active development. Nothing on this site constitutes financial advice. We accept no responsibility for any losses incurred from acting on information found here. These pages are intended for internal research purposes. You are strongly advised to conduct your own due diligence before making any investment decisions.
        </p>
    </div>
</footer>

<script>
// ========= DATA SOURCES =========
var POLY_URL = "https://ivanmassow.github.io/polyhunter/summary.json";
var HEDGE_URL = "https://ivanmassow.github.io/hedgefund-tracker/summary.json";
var CW_URL = "https://ivanmassow.github.io/company-watch/summary.json";

// ========= UTILITIES =========
function formatPnl(v) {
    if (v === null || v === undefined || v === 0) return '<span class="pnl-flat">0.0%</span>';
    var cls = v > 0 ? 'pnl-positive' : 'pnl-negative';
    var sign = v > 0 ? '+' : '';
    return '<span class="' + cls + '">' + sign + v.toFixed(1) + '%</span>';
}

function formatPrice(v) {
    if (!v && v !== 0) return '--';
    if (v < 1) return (v * 100).toFixed(1) + 'c';
    return '$' + v.toFixed(2);
}

function timeAgo(isoStr) {
    if (!isoStr) return '';
    var d = new Date(isoStr);
    var now = new Date();
    var mins = Math.floor((now - d) / 60000);
    if (mins < 1) return 'just now';
    if (mins < 60) return mins + 'min ago';
    var hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    var days = Math.floor(hrs / 24);
    return days + 'd ago';
}

function directionBadge(dir) {
    if (!dir) return '';
    var d = dir.toLowerCase();
    if (d === 'long' || d === 'higher') return '<span class="badge badge-' + d + '">' + dir.toUpperCase() + '</span>';
    if (d === 'short' || d === 'lower') return '<span class="badge badge-' + d + '">' + dir.toUpperCase() + '</span>';
    return '<span class="badge">' + dir + '</span>';
}

function stateBadge(state) {
    if (!state) return '';
    var s = state.toLowerCase();
    return '<span class="badge badge-' + s + '">' + state + '</span>';
}

function statusDot(status) {
    var s = (status || 'grey').toLowerCase();
    if (s === 'green' || s === 'active') return '<span class="status-dot dot-green"></span>';
    if (s === 'red') return '<span class="status-dot dot-red"></span>';
    if (s === 'orange') return '<span class="status-dot dot-orange"></span>';
    if (s === 'killed') return '<span class="status-dot dot-purple"></span>';
    return '<span class="status-dot dot-grey"></span>';
}

function bandChip(band) {
    if (!band) return '';
    var colors = {"A":"#0d7680","B":"#16a34a","C":"#f59e0b","D":"#ea580c","E":"#cc0000"};
    var bg = colors[band] || '#9ea2b0';
    return '<span class="band-chip" style="background:' + bg + '">' + band + '</span>';
}

function escHtml(s) {
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ========= POLY HUNTER =========
function renderPolyTable(positions, containerId) {
    var container = document.getElementById(containerId);
    if (!positions || positions.length === 0) {
        container.innerHTML = '<div class="loading-state" style="opacity:0.6">No candidates yet</div>';
        return;
    }

    var html = '<div class="trade-table-wrap"><table class="trade-table"><thead><tr>';
    html += '<th>State</th><th>Event</th><th>Edge</th><th>Direction</th>';
    html += '<th>Rating</th><th>Entry</th><th>Current</th><th>P&amp;L</th>';
    html += '</tr></thead><tbody>';

    for (var i = 0; i < positions.length; i++) {
        var t = positions[i];
        var isKilled = (t.state === 'KILLED');
        var rowCls = isKilled ? ' class="killed-row"' : '';

        html += '<tr' + rowCls + '>';
        html += '<td>' + stateBadge(t.state || 'EXPIRED') + '</td>';
        html += '<td class="asset-cell"><span class="asset-name">' + escHtml(t.event) + '</span>';
        if (isKilled && t.kill_reason) {
            html += '<span class="asset-sub">' + escHtml(t.kill_reason) + '</span>';
        }
        html += '</td>';
        html += '<td><span class="badge">' + escHtml(t.edge_type || '?') + '</span></td>';
        html += '<td>' + directionBadge(t.direction) + '</td>';
        html += '<td>' + bandChip(t.rating) + '</td>';
        html += '<td style="font-family:Montserrat,sans-serif;font-size:0.8rem">' + formatPrice(t.entry_price) + '</td>';
        html += '<td style="font-family:Montserrat,sans-serif;font-size:0.8rem">' + formatPrice(t.current_price) + '</td>';
        html += '<td>' + formatPnl(t.pnl_pct) + '</td>';
        html += '</tr>';
    }

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function renderPoly(data) {
    document.getElementById('poly-updated').textContent = 'Updated ' + timeAgo(data.updated_at);

    // Per-tail summary stats
    var st = data.short_tail || {};
    var lt = data.long_tail || {};

    document.getElementById('poly-short-total').textContent = st.total || 0;
    document.getElementById('poly-short-winners').textContent = st.winners || 0;
    document.getElementById('poly-short-losers').textContent = st.losers || 0;
    document.getElementById('poly-short-winrate').textContent = (st.win_rate || 0).toFixed(1) + '%';
    document.getElementById('poly-short-best').innerHTML = formatPnl(st.best_trade || 0);

    document.getElementById('poly-long-total').textContent = lt.total || 0;
    document.getElementById('poly-long-winners').textContent = lt.winners || 0;
    document.getElementById('poly-long-losers').textContent = lt.losers || 0;
    document.getElementById('poly-long-winrate').textContent = (lt.win_rate || 0).toFixed(1) + '%';
    document.getElementById('poly-long-best').innerHTML = formatPnl(lt.best_trade || 0);

    // Split positions by tail_type
    var positions = data.recent_positions || [];
    var shortPositions = [];
    var longPositions = [];
    for (var i = 0; i < positions.length; i++) {
        if (positions[i].tail_type === 'long') {
            longPositions.push(positions[i]);
        } else {
            shortPositions.push(positions[i]);
        }
    }

    renderPolyTable(shortPositions, 'poly-short-trades');
    renderPolyTable(longPositions, 'poly-long-trades');
}

// ========= HEDGE FUND =========
function renderHedge(data) {
    document.getElementById('hedge-total').textContent = data.total_positions || 0;
    document.getElementById('hedge-active').textContent = data.active_count || 0;
    document.getElementById('hedge-publish').textContent = data.publish_count || 0;
    document.getElementById('hedge-pending').textContent = data.pending_count || 0;
    document.getElementById('hedge-directions').textContent =
        (data.long_count || 0) + 'L / ' + (data.short_count || 0) + 'S';
    document.getElementById('hedge-updated').textContent = 'Updated ' + timeAgo(data.updated_at);

    var positions = data.recent_positions || data.active_trades || [];
    var container = document.getElementById('hedge-trades');

    if (positions.length === 0) {
        container.innerHTML = '<div class="loading-state" style="opacity:0.6">No data available yet</div>';
        return;
    }

    var html = '<div class="trade-table-wrap"><table class="trade-table"><thead><tr>';
    html += '<th>State</th><th>Asset</th><th>Ticker</th><th>Dir</th>';
    html += '<th>Band</th><th>Conf</th><th>Entry</th><th>P&amp;L</th>';
    html += '</tr></thead><tbody>';

    for (var i = 0; i < positions.length; i++) {
        var t = positions[i];
        var isKilled = (t.state === 'KILLED');
        var rowCls = isKilled ? ' class="killed-row"' : '';

        html += '<tr' + rowCls + '>';
        html += '<td>' + stateBadge(t.state) + '</td>';
        html += '<td class="asset-cell"><span class="asset-name">' + escHtml(t.asset) + '</span>';
        // Show headline or kill reason as subtitle
        if (t.headline) {
            html += '<span class="asset-sub">' + escHtml(t.headline) + '</span>';
        } else if (isKilled && t.kill_reason) {
            html += '<span class="asset-sub">' + escHtml(t.kill_reason) + '</span>';
        } else if (t.state_reason) {
            html += '<span class="asset-sub">' + escHtml(t.state_reason) + '</span>';
        }
        html += '</td>';
        html += '<td class="ticker-cell">' + escHtml(t.ticker || '--') + '</td>';
        html += '<td>' + directionBadge(t.direction) + '</td>';
        html += '<td>' + bandChip(t.band) + '</td>';
        html += '<td>';
        if (t.confidence) {
            html += '<span style="font-family:Montserrat,sans-serif;font-size:0.8rem">' + t.confidence + '%</span>';
        }
        html += '</td>';
        html += '<td style="font-family:Montserrat,sans-serif;font-size:0.8rem">' +
            (t.entry_price ? '$' + t.entry_price.toFixed(2) : '--') + '</td>';
        html += '<td>' + formatPnl(t.current_pnl) + '</td>';
        html += '</tr>';
    }

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// ========= COMPANY WATCH =========
function stanceBadgeColor(stance) {
    var s = (stance || '').toLowerCase();
    if (s === 'buy') return 'background:#dcfce7;color:#16a34a';
    if (s === 'sell') return 'background:#fef2f2;color:#cc0000';
    if (s === 'hold') return 'background:#fef3c7;color:#d97706';
    return 'background:#f1f5f9;color:#9ea2b0';
}

function renderCW(data) {
    document.getElementById('cw-updated').textContent = 'Updated ' + timeAgo(data.generated_at);

    var stocks = data.stocks || [];
    var container = document.getElementById('cw-tiles');

    if (stocks.length === 0) {
        // Backward compat: single-stock format
        if (data.ticker) {
            stocks = [data];
        } else {
            container.innerHTML = '<div class="loading-state" style="opacity:0.6">No data available yet</div>';
            return;
        }
    }

    var html = '';
    for (var i = 0; i < stocks.length; i++) {
        var s = stocks[i];
        var stance = (s.active && s.active.stance) || 'FLAT';
        var rConf = (s.active && s.active.report_confidence) || 0;
        var hConf = (s.active && s.active.house_confidence) || 0;
        var alpha = s.alpha || 0;
        var alphaColor = alpha > 0 ? '#16a34a' : (alpha < 0 ? '#cc0000' : '#9ea2b0');
        var price = s.current_price ? '$' + s.current_price.toFixed(2) : '--';
        var isDucking = s.active && s.active.is_ducking;

        html += '<a class="cw-tile" href="https://ivanmassow.github.io/company-watch/reports/' + escHtml(s.ticker) + '/latest.html">';
        html += '<div class="cw-tile-head">';
        html += '<div>';
        html += '<div class="cw-tile-ticker">' + escHtml(s.ticker) + '</div>';
        html += '<div class="cw-tile-company">' + escHtml(s.company || s.ticker) + '</div>';
        html += '</div>';
        html += '<span class="badge" style="' + stanceBadgeColor(stance) + ';padding:4px 12px;border-radius:20px;font-family:Montserrat,sans-serif;font-weight:700;font-size:0.82em">' + stance + '</span>';
        if (isDucking) html += ' <span class="badge badge-duck" style="margin-left:4px">DUCK</span>';
        html += '</div>';
        html += '<div class="cw-tile-price">' + price + '</div>';
        html += '<div class="cw-tile-stats">';
        html += '<div><span>Report:</span> <strong>' + (rConf ? rConf.toFixed(0) + '%' : '--') + '</strong></div>';
        html += '<div><span>House:</span> <strong>' + (hConf ? hConf.toFixed(0) + '%' : '--') + '</strong></div>';
        html += '<div><span>Alpha:</span> <strong style="color:' + alphaColor + '">' + (alpha > 0 ? '+' : '') + alpha.toFixed(2) + '%</strong></div>';
        html += '</div>';
        html += '</a>';
    }

    container.innerHTML = html;
}

// ========= HERO AGGREGATION =========
function updateHero(polyData, hedgeData, cwData) {
    var totalPoly = (polyData && polyData.total_candidates) || 0;
    var totalHedge = (hedgeData && hedgeData.total_positions) || 0;
    var cwStocks = (cwData && cwData.stocks) || [];
    var totalCW = cwStocks.length || (cwData && cwData.ticker ? 1 : 0);
    document.getElementById('hero-total').textContent = totalPoly + totalHedge + totalCW;

    var activeHedge = (hedgeData && hedgeData.active_count) || 0;
    var activePoly = 0;
    if (polyData && polyData.recent_positions) {
        for (var i = 0; i < polyData.recent_positions.length; i++) {
            if (polyData.recent_positions[i].state === 'ACTIVE') activePoly++;
        }
    }
    var activeCW = 0;
    for (var j = 0; j < cwStocks.length; j++) {
        if (cwStocks[j].active && cwStocks[j].active.state === 'HELD') activeCW++;
    }
    if (activeCW === 0 && cwData && cwData.active && cwData.active.state === 'HELD') activeCW = 1;
    document.getElementById('hero-active').textContent = activePoly + activeHedge + activeCW;

    // Individual win rates per system
    function setWR(id, val) {
        var el = document.getElementById(id);
        if (val > 0) {
            el.textContent = val.toFixed(1) + '%';
            el.className = 'hero-stat-value ' + (val >= 50 ? 'green' : '');
        } else {
            el.textContent = '--';
            el.className = 'hero-stat-value';
        }
    }
    setWR('hero-wr-poly', (polyData && polyData.win_rate) || 0);
    setWR('hero-wr-hedge', (hedgeData && hedgeData.win_rate) || 0);
    setWR('hero-wr-cw', (cwData && cwData.win_rate) || 0);
}

// ========= FETCH & RENDER =========
var polyData = null;
var hedgeData = null;
var cwData = null;

function fetchAndRender() {
    fetch(POLY_URL, { cache: 'no-cache' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            polyData = data;
            renderPoly(data);
            updateHero(polyData, hedgeData, cwData);
        })
        .catch(function(err) {
            console.warn('PolyHunter fetch error:', err);
            document.getElementById('poly-trades').innerHTML =
                '<div class="loading-state" style="opacity:0.5">Unable to load PolyHunter data</div>';
        });

    fetch(HEDGE_URL, { cache: 'no-cache' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            hedgeData = data;
            renderHedge(data);
            updateHero(polyData, hedgeData, cwData);
        })
        .catch(function(err) {
            console.warn('Hedge Fund fetch error:', err);
            document.getElementById('hedge-trades').innerHTML =
                '<div class="loading-state" style="opacity:0.5">Unable to load Hedge Fund data</div>';
        });

    fetch(CW_URL, { cache: 'no-cache' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            cwData = data;
            renderCW(data);
            updateHero(polyData, hedgeData, cwData);
        })
        .catch(function(err) {
            console.warn('Company Watch fetch error:', err);
            document.getElementById('cw-details').innerHTML =
                '<div class="loading-state" style="opacity:0.5">Unable to load Company Watch data</div>';
        });
}

// Initial load
fetchAndRender();

// Auto-refresh every 5 minutes
setInterval(fetchAndRender, 5 * 60 * 1000);
</script>

</body>
</html>